---
title: "Random Forest - Climate Data Analysis"
author: "Contributors: Joey Hulbert,... "
output: html_document
---

|            |            |            |            |
|:----------:|:----------:|:----------:|:----------:|
|[Redcedar](https://jmhulbert.github.io/open/redcedar)|[Data](https://jmhulbert.github.io/open/redcedar/data)|[ Analyses](https://jmhulbert.github.io/open/redcedar/analyses)|[Instructions](https://jmhulbert.github.io/open/redcedar/instructions)|
|             |           |            |            |

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r include=FALSE}
library(tidyverse)
library(randomForest)
library(caret)
library(rpart)
library(knitr)
```


> Please note this analysis and R Markdown document are in still in development :)

# Approach

The overall approach is to model empirical data collected by community scientists with ancillary climate data to identify important predictors of western redcedar dieback.

## iNat Data - Empirical Tree Points

The steps for wrangling the [data](https://jmhulbert.github.io/open/redcedar/data) are described [here](https://jmhulbert.github.io/open/redcedar/data).

```{r}
data <- read.csv('https://github.com/jmhulbert/open/raw/main/redcedar/data/data-modified.csv')
```

### Wrangle data into format for climateNA

Data were then subset to include only gps information to use in collecting ancillary data.


```{r}
gps <- data[c(2,24,25)] #subset data to only include id and gps coordinates
gps <- rename(gps,lat = latitude) %>% `colnames<-`(c("ID2","lat","long")) %>% mutate(el = ".") #columns were ranamed to match format for ClimateNA tool.
#write.csv(gps,file="/Users/redcedar/ServerFiles/open/redcedar/data/gps2232.csv") #named 2232 because data was downloaded after having 2232 observations
```

### Normal Data

Climate data then extracted with ClimateNA tool following the below process. Data were downloaded for the iNat GPS locations using the ClimateNA Tool.

ClimateNA version 7.40 -

* Climate data extraction process with ClimateNA
  + Convert data into format for climateNA use (see above)
  + In ClimateNA
    + Normal Data
      + Select input file (browse to gps2232 file)
      + Choose 'More Normal Data'
        + Select 'Normal_1991_2020.nrm'
      + Choose 'All variables(265)'
      + Specify output file

* Grouping explored
  + data averaged over 30 year normals (1991-2020)

## Variables

**Note the below analysis uses the iNat data with 1510 observations. Amazing!**

* Response variables included in this analysis
  + Tree canopy symptoms (binary)

* Explanatory variables included
  + Climate data
    + 30yr normals 1991-2020 (265 variables - annual, seasonal, monthly)


```{r}
normals <- read.csv('https://github.com/jmhulbert/open/raw/main/redcedar/data/gps2232_Normal_1991_2020MSY.csv')
colnames(normals) <- str_c("norm_",colnames(normals)) #change column names - not to be confused with decadal data
normals <- rename(normals, id = norm_ID2) #rename column 'ID2' (changed for ClimateNA tool) back to 'id'
```

```{r}
combo <- left_join(data,normals,by="id")
```

```{r}
combo.filtered <- combo %>% select(-c("field.optional...site.type",
                                      "field.optional...site.hydrology",
                                      "field.optional...site.location.description",
                                      "field.optional...site.area.disturbance.level",
                                      "field.optional...tree.size",
  "field.optional...slope.position",
  "field.optional...did.the.tree.have.heat.damage"
,"field.percent.canopy.affected...."
,"field.number.of.additional.unhealthy.trees..of.same.species..in.area..within.sight."
,"field.percent.of.trees..of.same.species..within.sight.that.are.unhealthy"
,"field.optional...access.to.water"
,"id"  
,"observed_on_string"                                                                     
,"observed_on"                                                                            
,"time_observed_at"                                                                       
,"time_zone"                                                                              
,"user_id"                                                                                
,"user_login"                                                                             
,"created_at"                                                                             
,"updated_at"
,"quality_grade"                                                                          
,"license"                                                                                
,"url"                                                                                    
,"image_url"                                                                              
,"sound_url"                                                                              
,"tag_list"                                                                               
,"description"                                                                            
,"num_identification_agreements"                                                          
,"num_identification_disagreements"                                                       
,"captive_cultivated"                                                                     
,"oauth_application_id"                                                                   
,"place_guess"                                                                            
,"latitude"                                                                               
,"longitude"                                                                              
,"positional_accuracy"                                                                    
,"private_place_guess"                                                                    
,"private_latitude"                                                                       
,"private_longitude"                                                                      
,"public_positional_accuracy"                                                             
,"geoprivacy"                                                                             
,"taxon_geoprivacy"                                                                       
,"coordinates_obscured"                                                                   
,"positioning_method"                                                                     
,"positioning_device"                                                                     
,"place_town_name"                                                                        
,"place_county_name"                                                                      
,"place_state_name"                                                                       
,"place_country_name"                                                                     
,"place_admin1_name"                                                                      
,"place_admin2_name"                                                                      
,"species_guess"                                                                          
,"scientific_name"
,"common_name"                                                                            
,"iconic_taxon_name"                                                                      
,"taxon_id"          
,"field.other.factors...are.there.signs.or.symptoms.of.insect..diseases..or.other.damage."
,"field.optional...what..other.factors..were.observed." 
, "field.optional...were.there.any.other.unhealthy.plant.species.on.the.site."             
 ,"field.optional...timing.of.symptoms.estimate"                                           
, "field.optional...estimated.time.spent.to.make.this.observation....of.minutes."          
, "field.optional...can.we.follow.up.with.you."
,"field.notes"
))
# combo.filtered <- combo.filtered[c(45,50:59,68:332,337:341,355:394,396:503,510:774)] 
```

Then, remove specific climate variables not useful as explanatory variables (e.g. norm_Latitutde)
```{r}
combo.filtered <- combo.filtered %>% select(-c(
"X"
,"user_name"
,"binary.tree.canopy.symptoms"
,"field.tree.canopy.symptoms"
,"field.dieback.percent"
,"norm_X"                                                                                   
,"norm_Latitude"                                                                            
,"norm_Longitude"                                                                           
,"norm_Elevation"))
```

Remove variables with variables that have near zero standard deviations (entire column is same value)

```{r include=FALSE}
#nearZeroVar(combo.filtered)
combo.filtered.nearzerovar <- combo.filtered[,-nearZeroVar(combo.filtered)]
#write.csv(combo.decade.filtered,file="./data/troubleshoot.csv")
```

```{r}
combo.filtered.nearzerovar <-as.data.frame(unclass(combo.filtered.nearzerovar),stringsAsFactors=TRUE) #change all chars to factors
```

```{r}
combo.filtered.nearzerovar <- na.omit(combo.filtered.nearzerovar)
```



#### Normal Model

```{r full rf model}
set.seed(71)
rf <- randomForest(reclassified.tree.canopy.symptoms ~ ., data=combo.filtered.nearzerovar, ntree=2001, importance=TRUE, na.action=na.omit, proximity=TRUE)
```

```{r}
rf
```

```{r}
plot(rf)
```

```{r fig.height=6,fig.width=9}
#Below code copied from: https://github.com/StatQuest/random_forest_demo/blob/master/random_forest_demo.R as described here: https://www.youtube.com/watch?v=6EXPYzbfLCE

## Start by converting the proximity matrix into a distance matrix. 

distance.matrix <- as.dist(1-rf$proximity)

mds.stuff <- cmdscale(distance.matrix, eig=TRUE, x.ret=TRUE)

## calculate the percentage of variation that each MDS axis accounts for...
mds.var.per <- round(mds.stuff$eig/sum(mds.stuff$eig)*100, 1)

## now make a fancy looking plot that shows the MDS axes and the variation:
mds.values <- mds.stuff$points
mds.data <- data.frame(Sample=rownames(mds.values),
  X=mds.values[,1],
  Y=mds.values[,2],
  Status=combo.filtered.nearzerovar$reclassified.tree.canopy.symptoms)

ggplot(data=mds.data, aes(x=X, y=Y, label=Sample)) + 
  geom_text(aes(color=Status)) +  
  stat_ellipse(geom="polygon",aes(fill=Status,color=Status),alpha=0.45) +
  theme_bw() + 
  scale_color_discrete() +
  scale_fill_discrete() +
  xlab(paste("MDS1 - ", mds.var.per[1], "%", sep="")) +
  ylab(paste("MDS2 - ", mds.var.per[2], "%", sep="")) +
  ggtitle("MDS plot using (1 - Random Forest Proximities)")

#By default, the stat_ellipse function draws a 95% confidence level for a multivariate t-distribution. You can modify this level with level argument.

#more info for ellipse https://r-charts.com/correlation/scatter-plot-ellipses-ggplot2/
```

```{r fig.height=9,fig.width=12}
varImpPlot(rf)
```

```{r}
importance <- varImp(rf,scale=TRUE)
plot(importance)
```
