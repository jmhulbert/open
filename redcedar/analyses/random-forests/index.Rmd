---
title: "Random Forest - Climate Data Analysis"
author: "Contributors: Joey Hulbert,... "
output: html_document
---

|            |            |            |            |
|:----------:|:----------:|:----------:|:----------:|
|[Redcedar](https://jmhulbert.github.io/open/redcedar)|[Data](https://jmhulbert.github.io/open/redcedar/data)|[ Analyses](https://jmhulbert.github.io/open/redcedar/analyses)|[Instructions](https://jmhulbert.github.io/open/redcedar/instructions)|
|             |           |            |            |

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

> Please note this analysis and R Markdown document are in still in development :)

# Approach

The overall approach is to model empirical data collected by community scientists with ancillary climate data to identify important predictors of western redcedar dieback.

## iNat Data - Empirical Tree Points

The steps for wrangling the [data](https://jmhulbert.github.io/open/redcedar/data) are described [here](https://jmhulbert.github.io/open/redcedar/data).

```{r}
data <- read.csv("./redcedar/data/data-modified.csv")
```

### Wrangle data into format for climateNA

Data were then subset to include only gps information to use in collecting ancillary data.

```{r}
gps <- data[c(1,22,23)] #subset data to only include id and gps coordinates
gps <- rename(gps,lat = latitude) %>% `colnames<-`(c("ID2","lat","long")) %>% mutate(el = ".") #columns were ranamed to match format for ClimateNA tool.
#write.csv(gps,file="./data/gps1500.csv") #named 1500 because data was downloaded after having 1500 observations
```

### Normal Data

Climate data then extracted with ClimateNA tool following the below process. Data were downloaded for the iNat GPS locations using the ClimateNA Tool.

ClimateNA version 7.21 - The latest version also supports command line access using system2(exe,"") commands, but you likely need to be running r in windows.

* Climate data extraction process with ClimateNA
  + Convert data into format for climateNA use (see below)
  + In ClimateNA
    + Normal Data
      + Select input file (browse to gps1500 file)
      + Choose 'More Normal Data'
        + Select 'Normal_1991_2020.nrm'
      + Choose 'All variables(265)'
      + Specify output file

* Grouping explored
  + data averaged over 30 year normals (1991-2020)

### Historical Time Series

Climate NA also allows you to download annual and seasonal data for multiple locations from 1901-2020. 

* Process
  + Select input file (browse to gps1500 file)
  + Select 'Historical Time Series'
  + Select 'Annual and Seasonal variables'
  + Specify start year (1901)
  + Specify end year (2020)
  + Click Start TS


## Variables

**Note the below analysis uses the iNat data with 1510 observations. Amazing!**

* Response variables included in this analysis
  + Tree canopy symptoms (binary)

* Explanatory variables included
  + Climate data
    + 30yr normals 1991-2020 (265 variables - annual, seasonal, monthly)


```{r}
normals <- read.csv("./data/gps1500_Normal_1991_2020MSY.csv")
colnames(normals) <- str_c("norm_",colnames(normals)) #change column names - not to be confused with decadal data
normals <- rename(normals, id = norm_ID2) #rename column 'ID2' (changed for ClimateNA tool) back to 'id'
```




```{r}
combo.filtered <- combo %>% select(-c("field.optional...site.type",
                                      "field.optional...site.hydrology",
                                      "field.optional...site.location.description",
                                      "field.optional...site.area.disturbance.level",
                                      "field.optional...tree.size",
  "field.optional...slope.position",
  "field.optional...did.the.tree.have.heat.damage"
,"field.percent.canopy.affected...."
,"field.number.of.additional.unhealthy.trees..of.same.species..in.area..within.sight."
,"field.percent.of.trees..of.same.species..within.sight.that.are.unhealthy"
,"field.optional...access.to.water"
,"id"  
,"observed_on_string"                                                                     
,"observed_on"                                                                            
,"time_observed_at"                                                                       
,"time_zone"                                                                              
,"user_id"                                                                                
,"user_login"                                                                             
,"created_at"                                                                             
,"updated_at"
,"quality_grade"                                                                          
,"license"                                                                                
,"url"                                                                                    
,"image_url"                                                                              
,"sound_url"                                                                              
,"tag_list"                                                                               
,"description"                                                                            
,"num_identification_agreements"                                                          
,"num_identification_disagreements"                                                       
,"captive_cultivated"                                                                     
,"oauth_application_id"                                                                   
,"place_guess"                                                                            
,"latitude"                                                                               
,"longitude"                                                                              
,"positional_accuracy"                                                                    
,"private_place_guess"                                                                    
,"private_latitude"                                                                       
,"private_longitude"                                                                      
,"public_positional_accuracy"                                                             
,"geoprivacy"                                                                             
,"taxon_geoprivacy"                                                                       
,"coordinates_obscured"                                                                   
,"positioning_method"                                                                     
,"positioning_device"                                                                     
,"place_town_name"                                                                        
,"place_county_name"                                                                      
,"place_state_name"                                                                       
,"place_country_name"                                                                     
,"place_admin1_name"                                                                      
,"place_admin2_name"                                                                      
,"species_guess"                                                                          
,"scientific_name"
,"common_name"                                                                            
,"iconic_taxon_name"                                                                      
,"taxon_id"          
,"field.other.factors...are.there.signs.or.symptoms.of.insect..diseases..or.other.damage."
,"field.optional...what..other.factors..were.observed." 
, "field.optional...were.there.any.other.unhealthy.plant.species.on.the.site."             
 ,"field.optional...timing.of.symptoms.estimate"                                           
, "field.optional...estimated.time.spent.to.make.this.observation....of.minutes."          
, "field.optional...can.we.follow.up.with.you."
,"field.notes"
))
# combo.filtered <- combo.filtered[c(45,50:59,68:332,337:341,355:394,396:503,510:774)] 
```

Then, remove specific climate variables not useful as explanatory variables (e.g. norm_Latitutde)
```{r}
combo.filtered <- combo.filtered %>% select(-c(
"X" 
,"Latitude"                                    
,"Longitude"
,"norm_X"                                                                                   
,"norm_Latitude"                                                                            
,"norm_Longitude"                                                                           
,"norm_Elevation"))
```

