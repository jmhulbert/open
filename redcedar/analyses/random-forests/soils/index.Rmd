---
title: "Random Forests - Polaris Soil Data Analysis"
author: 'Contributors: Joey Hulbert,...'
output: html_document
---

|            |            |            |            |
|:----------:|:----------:|:----------:|:----------:|
|[Redcedar](https://jmhulbert.github.io/open/redcedar)|[Data](https://jmhulbert.github.io/open/redcedar/data)|[ Analyses](https://jmhulbert.github.io/open/redcedar/analyses)|[Instructions](https://jmhulbert.github.io/open/redcedar/instructions)|
|             |           |            |            |


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE,warning=FALSE}
library(tidyverse)
#devtools::install_github("lhmrosso/XPolaris")
library(XPolaris)
```


# Approach

We used the [XPolaris package](https://github.com/lhmrosso/XPolaris) to download POLARIS soils tiles and extract data for 13 soils variables for all of our data points. 

Instructions for using this pacakage are available at https://github.com/lhmrosso/XPolaris

Then we completed a random forest analysis with the soils data to see what variables were the most important for classifying trees as healthy or unhealthy. 

# Data Wrangling

### Import iNat Data - Empirical Tree Points (Response variables)

The steps for wrangling the [data](https://jmhulbert.github.io/open/redcedar/data) are described [here](https://jmhulbert.github.io/open/redcedar/data).

```{r}
data <- read.csv('https://github.com/jmhulbert/open/raw/main/redcedar/data/data-modified.csv')
```

#### Format and export for collecting Polaris soil data with xPolaris Package

Data were subset to include only gps information to use in collecting ancillary data.

```{r}
gps.soils <- data[c(2,24,25)] #subset data to only include id and gps coordinates
gps.soils <- rename(gps.soils,lat = latitude) %>% `colnames<-`(c("ID","lat","long")) 
#write.csv(gps.soils,file="/Users/redcedar/ServerFiles/open/redcedar/data/gps.soils.2232.csv") #named 2232 because data was downloaded after having 2232 observations
```

Drop data with missing coordinates were filtered out - breaks code below otherwise
```{r}
gps.soils <- gps.soils %>% filter (lat!="")
```

```{r}
xplot(gps.soils)
```

We may need to filter out canada in later analysis, not sure if tiffs from BC will have data or be helpfu.
Everything above 49th parallel was NA. Filtering the Canada data beforehand might save some time in the data wrangling.


Tiles for soils data were downloaded using the ximages command in the package. 53 tiles for all 6 soil layer depths and all 13 variables (`r 53*6*13` tiles) were downloaded. This process took us close to 12 hours to complete. 

```{r cache=TRUE}
#mean_soils_data <- ximages(locations = gps.soils,
#                      statistics = c('mean'),
#                      variables = c('ph','om','clay','sand','silt','bd','hb','n','ksat','theta_r','theta_s','lambda','alpha'),
#                      layersdepths = c('0_5','5_15','15_30','30_60','60_100','100_200'))
#                     #variables = c('ph','om','clay','sand','silt','bd','hb','n','ksat','theta_r','theta_s'),
#                      #layersdepths = c('0_5','5_15','15_30','30_60','60_100','100_200'))


# These data were saved in our tempdir() at  "/var/folders/nc/nbgmcl_s2_q4d2r3z08pnjz00000gn/T//RtmpPU3kIf"
```


Next, we extracted the soils data from the tiles using the xsoil command. 


We received the below error from one raster file in the silt data, but we manually downloaded the tif file and replaced it in the data folder, then it worked fine. 

> Error in `dplyr::mutate()`:
ℹ In argument: `extracts = purrr::map2(...)`.
Caused by error in `purrr::map2()`:
ℹ In index: 27.
Caused by error:
! [extract] cannot read values

The below xsoil command worked fine after fixing that silt file mentioned above. 

```{r}
#mean_all_vars_xsoil<-xsoil(ximages_output=mean_soils_data)
```

12882 observations in final dataset with 18 variables (2221 obs x 6 soil horizons = `r 2221*6` - 500ish observations some reason.

Data were saved as [xsoil_data_all_13_vars.csv](https://github.com/jmhulbert/open/tree/main/redcedar/data/xsoil_data_all_13_vars.csv)

```{r}
#write.csv(mean_all_vars_xsoil,file="/Users/redcedar/ServerFiles/open/redcedar/data/xsoil_data_all_13_vars.csv")
```


# Random Forest Analysis



